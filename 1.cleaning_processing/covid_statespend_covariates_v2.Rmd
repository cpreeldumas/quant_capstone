---
title: "covid_statespend_covariates_v2"
author: "Denise Upton"
date: "2024-02-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

# set up
library(readr)
library(readxl)
library(lubridate)
library(tidyverse)
library(janitor)
library(DT)
```

## State Spending

* Housing, Health, & Public Welfare spending as a fraction of total spending
* Geolevel: state
* Frequency: yearly
* Source: [Urban Institute State Finance Data](https://state-local-finance-data.taxpolicycenter.org/pages.cfm)

```{r}
state_spending <- read_excel("/quant_capstone/data_raw/state_spending_urban.xlsx",
                           range = "A3:E207") %>% 
  clean_names("snake") %>%
  filter(state != "United States") %>% 
  left_join(read_excel("/quant_capstone/data_raw/state_abbrev_crosswalk.xlsx"),
            by = "state") %>% 
  rename(state_full = state,
         state = postal) %>% 
  mutate(state_fips = str_pad(as.character(state_fips), width = 2, side = "left", pad = "0"))

head(state_spending) %>% datatable()
```

## COVID-19 Incidence Rate

* Count of COVID-19 infections per 100,000
* Geolevel: county
* Frequency: monthly
* Source: [CDC U.S. State and Territorial Public Mask Mandates From April 10, 2020 through July 20, 2021 by County by Day](https://data.cdc.gov/Public-Health-Surveillance/Weekly-COVID-19-County-Level-of-Community-Transmis/jgk8-6dpn/about_data)

```{r}

#read county-level data
county_covid_rates <- read_csv("~/Google Drive/My Drive/_Wagner/2024-01/Capstone/Data/Weekly_COVID-19_County_Level_of_Community_Transmission_Historical_Changes_-_ARCHIVED_20240213.csv") %>%
  clean_names("snake") %>%
  rename("covid_case_rate" = "cases_per_100k_7_day_count_change") %>% 
  mutate(date = as.Date(date, format = '%m/%d/%Y'))


#sort by date to see earliest
county_covid_rates %>%
  group_by(date) %>% 
  tally() %>% 
  arrange(date) %>% 
  datatable()

#aggregate to month-year average
county_covid_rates %>%
  arrange(date) %>% 
  filter(date >= "2020-07-01") %>%
  mutate(ym = format(date, '%Y-%m')) %>% 
  group_by(ym, fips_code) %>% 
  summarize(covid_case_rate = mean(covid_case_rate)) %>%
  datatable()

```

* convert  

## Mask Mandates

* Percent of study period mask mandate is in place
* Geolevel: county
* Frequency: 3xmonthly
* Source: [CDC U.S. State and Territorial Public Mask Mandates From April 10, 2020 through July 20, 2021 by County by Day](https://data.cdc.gov/Policy-Surveillance/U-S-State-and-Territorial-Public-Mask-Mandates-Fro/62d6-pm5i/about_data)
* Notes: masks_order_code 1=yes; 2=no

make no=0
sum yes/# dates over study period (07/01/2020+)

```{r}
#read county-level data
county_mask_mandates <- read_csv("~/Google Drive/My Drive/_Wagner/2024-01/Capstone/Data/U.S._State_and_Territorial_Public_Mask_Mandates_From_April_10__2020_through_July_20__2021_by_County_by_Day_20240217.csv") %>%
  clean_names("snake")

#sort by date to see earliest
county_mask_mandates %>%
  group_by(date) %>% 
  tally() %>% 
  arrange(date) %>% 
  datatable()

#aggregate data to month-year
county_mask_mandates %>%
  mutate(masks_order_code = replace(masks_order_code, masks_order_code == 2, "0")) %>%
  filter(date >= "2020-07-01") %>%
  mutate(ym = format(date, '%Y-%m')) %>% 
  group_by(ym, fips_code) %>% 
  summarize(masks_order_code = max(masks_order_code)) %>% 
  datatable()

#create new df with fips + percent of study period with mask mandate

```