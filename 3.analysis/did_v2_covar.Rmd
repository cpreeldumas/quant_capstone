---
title: "DiD Model w Covariates"
author: "Camille Preel-Dumas"
date: "Updated: `r format(Sys.time(), '%a, %b %d, %Y at %I:%M %p')`"
output: 
  html_document:
    highlight: tango
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: false
    df_print: kable
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)

# set up
library(readr)
library(lubridate)
library(tidyverse)
library(janitor)
library(did)
library(naniar)
library(zoo)
library(plm)
library(DT)
library(broom)
library(scales)
library(gtools)
library(stargazer)
library(sjPlot)

#import data
bls_data <- read_csv("/Users/cpreeldumas/Documents/GitHub/quant_capstone/data_clean/data_v2.csv") %>% 
  clean_names("snake") #convert column names to snake case

glimpse(bls_data)
```

# Initial Exploration Phase

This is a second pass at using the CS-DID package. Next steps include:

1. Adding anticipatory effects (if any) - might need to test the other deadlines that got pushed (to test how solid the anticipation is). Fir ex: moratorium is initially set to expire in March, then it's pushed in February a few months, we should already be seeing effect in Jan and Feb.
2. Testing whether seasonality poses a threat

# Methodology decisions

1. Study period: July 2020 - April 2023 (expiration of MA moratorium)
2. Dropping DC, PR, and 1 Texas County

# Note on Covariates

* The did package requires that covariates be time-invariant. For time varying covariates, the did package sets the value of the covariate to be equal to the value of the covariate in the “base period” where, 
  * in post-treatment periods the base period is the period immediately before observations in a particular group become treated (when there is anticipation, it is before anticipation effects start too), 
  * and in pre-treatment periods the base period is the period right before the current period. 

# Prep data for CS-DID
```{r, include = FALSE}
#missingness
miss_var_summary(bls_data)

#why are these state missing state_start? 
bls_data %>% 
  filter(is.na(state_start)) %>% 
  group_by(state) %>% 
  tally()

bls_data %>% arrange(desc(date))

#prep dataset for CS-DID package
bls_data_did <- bls_data %>% 
  mutate(laborforce_16over_percentage = (laborforce_16over / population_16over)*100) %>% 
  mutate(idname = as.numeric(paste0(state_fips, county_fips)),
         date = ym(date)) %>% 
  # limiting dataset to July 2020 - April 2023 (expiration of MA moratorium)
  filter(date >= "2020-07-01" & date <= "2023-04-01") %>% 
  # making numeric version of data for DID package
  mutate(new_year_mo = as.numeric(as.yearmon(date))) %>% 
  mutate(across(c(state_start, state_end, federal_start, federal_end), mdy)) %>% 
  #making a numeric version of dates for first treat column
  mutate(across(
    .cols = c(state_start, state_end, federal_start, federal_end), 
    .fns = ~ as.numeric(as.yearmon(.x)),
    .names = "{.col}_new_year_mo")) %>% 
  mutate(first_treat = case_when(
    state == "MA" ~ 0, #never-treated group
    treatment == 1 ~ federal_end_new_year_mo,
    treatment == 0 ~ state_end_new_year_mo)) 


#dropping all NAs for now
bls_data_did_nodc <- bls_data_did %>% 
  filter(state != "DC" & state != "PR" & county != "Bailey County, Texas")
```

```{r, include = FALSE}
# misc checks
bls_data_did %>% 
  group_by(state, treatment, federal_end, state_end, first_treat) %>% 
  tally()

bls_data_did %>% 
  group_by(date, date_num) %>% 
  tally() %>% 
  arrange(date_num)

# checking the coding of treatment v. control
bls_data_did_nodc %>% 
  group_by(treatment, federal_end, state_end, first_treat) %>% 
  tally()

# obs by group
bls_data_did_nodc %>% 
  group_by(date, new_year_mo) %>% 
  tally()

obs_by_group <- bls_data_did_nodc %>% 
  group_by(first_treat) %>% 
  tally() %>% 
  transmute(`Treatment Group` = round(first_treat, digits = 2),
            `Observations` = scales::comma(n))

write.table(obs_by_group , "/Users/cpreeldumas/Desktop/SPRING 2024/Capstone/interim report/obs_by_group.txt", sep = "\t", row.names = FALSE, quote = FALSE)

bls_data_did_nodc %>% 
  filter(year == "2021") %>% 
  ggplot(aes(x = unemployment_rate)) + geom_histogram()

bls_data_did_nodc %>% group_by(treatment, state) %>% tally()
#illinois

bls_data_did_nodc %>% filter(state == "IL")
```


# CS-DID

idname = fips
tname = date
yname = unemployment_rate
gname = first_treat
xformla = ~1 

## Covariates

renters_occupied_percentage +
                     black_or_african_american_percentage + 
                     hispanic_or_latino_percentage +
                     bachelors_percentage +
                     median_age + 
                     median_income + 
                     laborforce_16over + 
                     health_spending + 
                     housing_spending + 
                     welfare_spending + 
                     pretreat_covid_rate + 
                     pretreat_maskmandate_pct

                     
#### Conditional Pre-Test
```{r, warning = FALSE, message = FALSE}
pre_test <- conditional_did_pretest(yname = "unemployment_rate",
                        tname= "new_year_mo",
                        idname = "idname",
                        gname = "first_treat",
                        xformla = ~
                          renters_occupied_percentage +
                     black_or_african_american_percentage + 
                     hispanic_or_latino_percentage +
                     bachelors_percentage +
                     median_age + 
                     median_income + 
                     laborforce_16over,
                        data = bls_data_did_nodc,
                        control_group = "notyettreated")
```
### Event study pre-test

#### Simple LM
```{r}
bls_data_common_pre <- bls_data_did_nodc %>% 
  filter(date < "2021-09-01") %>% 
    mutate(
      time = case_when(
      date == "2021-08-01" ~ 0,
      date == "2021-07-01" ~ -1,
      date == "2021-06-01" ~ -2,
      date == "2021-05-01" ~ -3,
      date == "2021-04-01" ~ -4,
      date == "2021-03-01" ~ -5,
      date == "2021-02-01" ~ -6,
      date == "2021-01-01" ~ -7,
      date == "2020-12-01" ~ -8,
      date == "2020-11-01" ~ -9,
      date == "2020-10-01" ~ -10,
      date == "2020-09-01" ~ -11,
      date == "2020-08-01" ~ -12,
      date == "2020-07-01" ~ -13),
      time = factor(time, levels = c("0", "-1", "-2", "-3", "-4", "-5", "-6", "-7", "-8", "-9"
                                     , "-10", "-11", "-12", "-13")),
      time = relevel(time, ref = "0"))



pre_testlm <- lm(unemployment_rate ~ treatment + time + treatment*time, 
                 data = bls_data_common_pre)

pretest_lm_sum <- summary(pre_testlm)

stargazer(pre_testlm, type="text",  out="/Users/cpreeldumas/Desktop/SPRING 2024/Capstone/interim report/pretestlm_table.txt",
          dep.var.labels = "Unemployment Rate")
```

```{r}
plot_model(pre_testlm, title = "Unemployment Rate")
```




####  Panel LM
```{r}
pre_test <- plm(unemployment_rate ~ treatment + renters_occupied_percentage +
                   black_or_african_american_percentage + 
                   hispanic_or_latino_percentage +
                   bachelors_percentage +
                   median_age + 
                   median_income + 
                   laborforce_16over_percentage,
                data = bls_data_common_pre,
                model = "within",
                index = c("new_year_mo", "idname"))
summary(pre_test)
index(pre_test)

pretest_table <- tidy(pre_test) %>% 
  mutate(`Significance`= stars.pval(p.value)) %>% 
  transmute(`Variable` = term,
            `Estimate` = round(estimate, digits = 3), 
            `Std. Error` = round(std.error, digits = 3),
            `T-Value` = round(statistic, digits = 3), 
            `P-Value` = formatC(p.value, format = "e", digits = 2),
            `Significance`) %>% 
  mutate(`Variable` = case_when(
`Variable` == 'treatment' ~ "Treatment",
`Variable` == 'renters_occupied_percentage' ~ "Share of Renters",
`Variable` == 'black_or_african_american_percentage' ~ "Share Black",
`Variable` == 'hispanic_or_latino_percentage' ~ "Share Hispanic",
`Variable` == 'bachelors_percentage' ~ "Share Bachelors Degree",
`Variable` == 'median_age' ~ "Median Age",	
`Variable` == 'median_income' ~ "Median Income",
`Variable` == 'laborforce_16over_percentage' ~ "Share in Labor Force"))

write.table(pretest_table, "/Users/cpreeldumas/Desktop/SPRING 2024/Capstone/interim report/pretest_table.txt", sep = "\t", row.names = FALSE, quote = FALSE)

stargazer(pre_test, type="html",  out="/Users/cpreeldumas/Desktop/SPRING 2024/Capstone/interim report/pretest_table.htm",
           covariate.labels=c("Treatment", "Share of Renters", "Share Black", "Share Hispanic", "Share Bachelors Degree",
                              "Median Age", "Median Income", "Share in Labor Force"),
          dep.var.labels = "Unemployment Rate")
```


#### Group-time average treatment effects
```{r}
attgt_nocovar <- att_gt(yname = "unemployment_rate",
                   gname = "first_treat",
                   idname = "idname",
                   tname = "new_year_mo",
                   clustervars = "idname",
                   allow_unbalanced_panel = TRUE,
                   xformla = ~ renters_occupied_percentage +
                     black_or_african_american_percentage + 
                     hispanic_or_latino_percentage +
                     bachelors_percentage +
                     median_income + 
                     laborforce_16over,
                   control_group = "notyettreated",
                   data = bls_data_did_nodc)

summary(attgt_nocovar)
ggdid(attgt_nocovar, ylab = "ATT") +
  scale_x_continuous(name = "Date",
                     breaks=seq(1,34,6), 
                     labels = c("2020-07",
                                "2021-01", 
                                "2021-07", 
                                "2022-01", 
                                "2022-07", 
                                "2023-01"))
```

### Aggregate 
```{r}
# aggregate the group-time average treatment effects
attgt_nocovar_dyn <- aggte(attgt_nocovar, type = "dynamic")
summary(attgt_nocovar_dyn)

ggdid(attgt_nocovar_dyn) +
  scale_x_continuous(name = "Length of Exposure to Moratorium Lift")

tidy_attgt_nocovar_dyn <- tidy(attgt_nocovar_dyn) %>%  mutate(`Significance`= stars.pval(p.value))

write.table(tidy_attgt_nocovar_dyn, "/Users/cpreeldumas/Desktop/SPRING 2024/Capstone/interim report/attgt_nocovar_dyn.txt", sep = "\t", row.names = FALSE, quote = FALSE)
```

# Issues so far

1. Large standard errors
